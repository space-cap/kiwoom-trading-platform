# 키움 REST API 조건검색 시스템 PRD (Product Requirements Document)

## 1. 개요

### 1.1 문서 정보
- **문서 버전**: 1.0
- **작성일**: 2025-11-08
- **프로젝트명**: 키움 REST API 조건검색 시스템

### 1.2 목적
키움증권의 REST API를 활용하여 실시간 조건검색 기능을 구현하고, 조건에 부합하는 종목을 자동으로 모니터링하는 시스템을 개발한다.

### 1.3 배경
- 키움증권 OpenAPI+는 Windows 환경과 ActiveX에 의존적
- REST API를 통해 크로스 플랫폼 지원 및 클라우드 배포 가능
- 조건검색을 통한 자동화된 종목 발굴 시스템 필요

## 2. 시스템 목표

### 2.1 핵심 목표
1. 키움 REST API를 통한 조건검색 기능 구현
2. 실시간 조건 부합 종목 모니터링
3. 다중 조건 동시 검색 지원
4. 검색 결과의 효율적인 저장 및 관리

### 2.2 성능 목표
- API 호출 응답 시간: 3초 이내
- 조건검색 결과 갱신 주기: 설정 가능 (기본 30초)
- 동시 모니터링 조건 수: 최소 10개 이상
- 시스템 가동률: 99% 이상

## 3. 기능 요구사항

### 3.1 인증 및 토큰 관리
#### 3.1.1 OAuth 2.0 인증
- **우선순위**: P0 (필수)
- **설명**: 키움 REST API OAuth 2.0 인증 프로세스 구현
- **세부 기능**:
  - App Key, App Secret을 이용한 인증
  - Access Token 발급 및 저장
  - Token 자동 갱신 (만료 전)
  - 인증 실패 시 재시도 로직

#### 3.1.2 접근 토큰 관리
- **우선순위**: P0 (필수)
- **설명**: 접근 토큰의 라이프사이클 관리
- **세부 기능**:
  - Token 만료 시간 추적
  - Token 자동 갱신
  - Token 안전한 저장 (환경 변수 또는 암호화된 설정 파일)

### 3.2 조건검색 목록 조회
#### 3.2.1 등록된 조건식 조회
- **우선순위**: P0 (필수)
- **설명**: HTS에 등록된 조건검색 목록 조회
- **API 엔드포인트**: `/uapi/domestic-stock/v1/quotations/psearch-result`
- **세부 기능**:
  - 사용자가 HTS에서 등록한 조건검색 목록 가져오기
  - 조건식 번호(seq), 조건명 파싱
  - 조건검색 목록 캐싱

### 3.3 조건검색 실행
#### 3.3.1 단일 조건 검색
- **우선순위**: P0 (필수)
- **설명**: 특정 조건식에 부합하는 종목 검색
- **API 엔드포인트**: `/uapi/domestic-stock/v1/quotations/psearch-result`
- **세부 기능**:
  - 조건식 번호를 이용한 검색 실행
  - 검색 결과 종목 리스트 수신
  - 종목코드, 종목명, 현재가 등 기본 정보 파싱

#### 3.3.2 다중 조건 검색
- **우선순위**: P1 (높음)
- **설명**: 여러 조건을 동시에 검색
- **세부 기능**:
  - 복수의 조건식 동시 실행
  - 비동기 처리를 통한 성능 최적화
  - 조건별 결과 집계

#### 3.3.3 교집합/합집합 검색
- **우선순위**: P2 (중간)
- **설명**: 여러 조건의 교집합 또는 합집합 결과 제공
- **세부 기능**:
  - 조건 A AND 조건 B (교집합)
  - 조건 A OR 조건 B (합집합)
  - 조건 결과 필터링 및 정렬

### 3.4 실시간 모니터링
#### 3.4.1 주기적 조건검색
- **우선순위**: P0 (필수)
- **설명**: 설정된 주기로 조건검색 반복 실행
- **세부 기능**:
  - 검색 주기 설정 (초 단위)
  - 스케줄러를 이용한 자동 실행
  - 장 운영 시간 체크 (평일 09:00-15:30)

#### 3.4.2 신규 편입 종목 감지
- **우선순위**: P1 (높음)
- **설명**: 이전 검색 결과와 비교하여 신규 편입 종목 감지
- **세부 기능**:
  - 이전 결과와 현재 결과 비교
  - 신규 편입 종목 알림
  - 편입/이탈 히스토리 기록

#### 3.4.3 조건 이탈 종목 감지
- **우선순위**: P2 (중간)
- **설명**: 조건에서 이탈한 종목 감지
- **세부 기능**:
  - 이탈 종목 추적
  - 이탈 시점 기록

### 3.5 종목 정보 조회
#### 3.5.1 기본 시세 정보
- **우선순위**: P1 (높음)
- **설명**: 검색된 종목의 상세 시세 정보 조회
- **API 엔드포인트**: `/uapi/domestic-stock/v1/quotations/inquire-price`
- **세부 기능**:
  - 현재가, 등락률, 거래량
  - 시가, 고가, 저가
  - 거래대금, 시가총액

#### 3.5.2 호가 정보
- **우선순위**: P2 (중간)
- **설명**: 종목별 호가 정보 조회
- **세부 기능**:
  - 매도/매수 호가
  - 호가 잔량
  - 호가 스프레드

### 3.6 데이터 저장 및 관리
#### 3.6.1 검색 결과 저장
- **우선순위**: P1 (높음)
- **설명**: 조건검색 결과를 데이터베이스에 저장
- **세부 기능**:
  - SQLite/PostgreSQL 지원
  - 검색 시점, 조건명, 종목 정보 저장
  - 중복 데이터 처리

#### 3.6.2 히스토리 관리
- **우선순위**: P2 (중간)
- **설명**: 조건검색 히스토리 관리
- **세부 기능**:
  - 일자별 검색 결과 조회
  - 종목별 편입/이탈 히스토리
  - 데이터 보관 기간 설정 (기본 90일)

#### 3.6.3 데이터 내보내기
- **우선순위**: P2 (중간)
- **설명**: 검색 결과 내보내기
- **세부 기능**:
  - CSV 형식 내보내기
  - JSON 형식 내보내기
  - Excel 형식 내보내기

### 3.7 알림 시스템
#### 3.7.1 신규 종목 알림
- **우선순위**: P1 (높음)
- **설명**: 조건에 신규 편입된 종목 알림
- **세부 기능**:
  - 콘솔 로그 출력
  - 파일 로그 저장
  - 이메일 알림 (선택)
  - Slack/Discord 웹훅 (선택)

#### 3.7.2 시스템 상태 알림
- **우선순위**: P2 (중간)
- **설명**: 시스템 오류 및 상태 알림
- **세부 기능**:
  - API 호출 실패 알림
  - Token 갱신 실패 알림
  - 시스템 재시작 알림

### 3.8 설정 관리
#### 3.8.1 설정 파일
- **우선순위**: P0 (필수)
- **설명**: YAML/JSON 기반 설정 파일
- **세부 기능**:
  - API 인증 정보
  - 모니터링할 조건 목록
  - 검색 주기 설정
  - 알림 설정
  - 로그 레벨 설정

#### 3.8.2 동적 설정 변경
- **우선순위**: P2 (중간)
- **설명**: 시스템 재시작 없이 설정 변경
- **세부 기능**:
  - 설정 파일 핫 리로드
  - 조건 추가/제거
  - 검색 주기 변경

## 4. 비기능 요구사항

### 4.1 성능
- API 호출 간 적절한 딜레이 (Rate Limit 준수)
- 다중 조건 검색 시 병렬 처리
- 메모리 효율적인 데이터 구조 사용
- 데이터베이스 쿼리 최적화

### 4.2 안정성
- API 호출 실패 시 재시도 로직 (최대 3회)
- Exponential Backoff 적용
- 예외 처리 및 로깅
- 장애 발생 시 안전한 종료

### 4.3 보안
- API Key, Secret 환경 변수 관리
- Token 암호화 저장
- 민감 정보 로그 제외
- HTTPS 통신 강제

### 4.4 유지보수성
- 모듈화된 코드 구조
- 단위 테스트 커버리지 70% 이상
- 명확한 로깅 및 에러 메시지
- API 버전 관리

### 4.5 확장성
- 새로운 API 엔드포인트 추가 용이
- 다양한 데이터베이스 지원
- 플러그인 아키텍처 고려
- 마이크로서비스 전환 가능한 구조

## 5. 기술 스택

### 5.1 백엔드
- **언어**: Python 3.10+
- **프레임워크**: FastAPI (API 서버 구축 시)
- **HTTP 클라이언트**: httpx (비동기 지원)
- **스케줄러**: APScheduler
- **데이터베이스**: SQLAlchemy + SQLite/PostgreSQL

### 5.2 인프라
- **컨테이너**: Docker
- **로깅**: loguru 또는 structlog
- **환경 관리**: python-dotenv
- **의존성 관리**: Poetry

### 5.3 테스팅
- **단위 테스트**: pytest
- **Mock**: pytest-mock
- **비동기 테스트**: pytest-asyncio
- **커버리지**: pytest-cov

## 6. 시스템 아키텍처

### 6.1 레이어 구조
```
┌─────────────────────────────────────┐
│     Application Layer               │
│  (CLI, API Server, Scheduler)       │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│     Service Layer                   │
│  (Business Logic)                   │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│     Repository Layer                │
│  (Data Access)                      │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│     External APIs & Database        │
│  (Kiwoom REST API, SQLite/PostgreSQL)│
└─────────────────────────────────────┘
```

### 6.2 주요 컴포넌트
1. **AuthManager**: OAuth 인증 및 토큰 관리
2. **ApiClient**: 키움 REST API 통신 클라이언트
3. **ConditionSearchService**: 조건검색 비즈니스 로직
4. **MonitoringService**: 실시간 모니터링 서비스
5. **NotificationService**: 알림 발송 서비스
6. **DatabaseRepository**: 데이터 저장/조회
7. **ConfigManager**: 설정 관리
8. **Scheduler**: 주기적 작업 스케줄링

## 7. API 명세

### 7.1 키움 REST API 엔드포인트
#### 7.1.1 OAuth 인증
```
POST /oauth2/tokenP
Content-Type: application/json

{
  "grant_type": "client_credentials",
  "appkey": "{APP_KEY}",
  "appsecret": "{APP_SECRET}"
}
```

#### 7.1.2 조건검색 목록 조회
```
GET /uapi/domestic-stock/v1/quotations/psearch-result
Headers:
  - authorization: Bearer {ACCESS_TOKEN}
  - appkey: {APP_KEY}
  - appsecret: {APP_SECRET}
  - tr_id: HHKST03900300
```

#### 7.1.3 조건검색 실행
```
GET /uapi/domestic-stock/v1/quotations/psearch-result
Headers:
  - authorization: Bearer {ACCESS_TOKEN}
  - appkey: {APP_KEY}
  - appsecret: {APP_SECRET}
  - tr_id: HHKST03900400
Query Parameters:
  - user_id: 사용자 ID
  - seq: 조건식 번호
```

#### 7.1.4 주식 현재가 시세
```
GET /uapi/domestic-stock/v1/quotations/inquire-price
Headers:
  - authorization: Bearer {ACCESS_TOKEN}
  - appkey: {APP_KEY}
  - appsecret: {APP_SECRET}
  - tr_id: FHKST01010100
Query Parameters:
  - FID_COND_MRKT_DIV_CODE: 시장 구분 (J: 주식)
  - FID_INPUT_ISCD: 종목코드
```

### 7.2 Rate Limit
- 초당 최대 20건
- 분당 최대 1,000건
- API 호출 간 최소 50ms 대기

## 8. 데이터 모델

### 8.1 Condition (조건식)
```python
{
  "id": int,
  "seq": str,              # 조건식 번호
  "name": str,             # 조건명
  "description": str,      # 설명
  "is_active": bool,       # 활성화 여부
  "created_at": datetime,
  "updated_at": datetime
}
```

### 8.2 SearchResult (검색 결과)
```python
{
  "id": int,
  "condition_id": int,     # 조건식 ID
  "stock_code": str,       # 종목코드
  "stock_name": str,       # 종목명
  "current_price": int,    # 현재가
  "change_rate": float,    # 등락률
  "volume": int,           # 거래량
  "searched_at": datetime, # 검색 시점
  "is_new_entry": bool     # 신규 편입 여부
}
```

### 8.3 StockInfo (종목 정보)
```python
{
  "stock_code": str,       # 종목코드
  "stock_name": str,       # 종목명
  "market": str,           # 시장 구분
  "sector": str,           # 업종
  "created_at": datetime,
  "updated_at": datetime
}
```

### 8.4 MonitoringHistory (모니터링 히스토리)
```python
{
  "id": int,
  "condition_id": int,
  "execution_time": datetime,
  "result_count": int,     # 검색 결과 수
  "new_entry_count": int,  # 신규 편입 수
  "status": str,           # success, failed
  "error_message": str     # 오류 메시지
}
```

## 9. 사용자 시나리오

### 9.1 시나리오 1: 초기 설정 및 실행
1. 사용자가 키움증권 App Key/Secret 발급
2. 환경 변수 또는 설정 파일에 인증 정보 입력
3. HTS에서 조건검색 등록
4. 시스템 실행 및 조건검색 목록 자동 로드
5. 모니터링할 조건 선택
6. 실시간 모니터링 시작

### 9.2 시나리오 2: 신규 종목 발견 및 알림
1. 시스템이 주기적으로 조건검색 실행
2. 조건에 신규 편입된 종목 발견
3. 종목 정보 데이터베이스에 저장
4. 사용자에게 알림 발송 (콘솔/로그/Slack)
5. 사용자가 알림 확인 및 종목 분석

### 9.3 시나리오 3: 다중 조건 교집합 검색
1. 사용자가 여러 조건을 선택
2. 각 조건별로 검색 실행
3. 모든 조건에 부합하는 종목 필터링
4. 교집합 결과를 별도 리스트로 저장
5. 결과 조회 및 내보내기

## 10. 에러 처리

### 10.1 API 에러
- **40000번대 에러**: 인증 오류 → Token 재발급
- **50000번대 에러**: 서버 오류 → 재시도 로직
- **Rate Limit 초과**: 대기 후 재시도
- **네트워크 오류**: Exponential Backoff

### 10.2 데이터 에러
- **중복 데이터**: Unique 제약 조건으로 방지
- **데이터 형식 오류**: Validation 레이어에서 검증
- **NULL 값 처리**: 기본값 설정 또는 Optional 처리

### 10.3 시스템 에러
- **메모리 부족**: 배치 처리 및 데이터 정리
- **디스크 부족**: 로그 로테이션 및 데이터 아카이빙
- **타임아웃**: 타임아웃 설정 및 재시도

## 11. 테스트 계획

### 11.1 단위 테스트
- AuthManager Token 발급/갱신 테스트
- ApiClient HTTP 요청/응답 테스트
- ConditionSearchService 비즈니스 로직 테스트
- DatabaseRepository CRUD 테스트

### 11.2 통합 테스트
- API 호출부터 데이터 저장까지 End-to-End 테스트
- 다중 조건 검색 통합 테스트
- 알림 시스템 통합 테스트

### 11.3 부하 테스트
- 동시 다발적 API 호출 테스트
- Rate Limit 상황에서의 동작 테스트
- 대용량 데이터 처리 테스트

## 12. 배포 및 운영

### 12.1 배포 전략
- Docker 컨테이너 기반 배포
- 환경별 설정 파일 분리 (dev, staging, prod)
- CI/CD 파이프라인 구축

### 12.2 모니터링
- 애플리케이션 로그 모니터링
- API 호출 성공률 추적
- 시스템 리소스 사용량 모니터링
- 알림 발송 성공률 추적

### 12.3 백업 및 복구
- 데이터베이스 정기 백업 (일 1회)
- 설정 파일 버전 관리
- 장애 발생 시 복구 절차 문서화

## 13. 마일스톤

### Phase 1: 기본 기능 구현 (4주)
- Week 1: 프로젝트 설정, 인증 시스템
- Week 2: API 클라이언트, 조건검색 기본 기능
- Week 3: 데이터베이스 연동, 검색 결과 저장
- Week 4: 테스트 및 버그 수정

### Phase 2: 실시간 모니터링 (3주)
- Week 5: 스케줄러 구현, 주기적 검색
- Week 6: 신규 편입 감지, 알림 시스템
- Week 7: 통합 테스트 및 최적화

### Phase 3: 고급 기능 (3주)
- Week 8: 다중 조건 검색, 교집합/합집합
- Week 9: 데이터 내보내기, 히스토리 관리
- Week 10: 성능 튜닝, 문서화

### Phase 4: 배포 및 운영 (2주)
- Week 11: Docker 컨테이너화, CI/CD 구축
- Week 12: 프로덕션 배포, 모니터링 설정

## 14. 위험 요소 및 대응

### 14.1 위험 요소
1. **API 스펙 변경**: 키움 API 스펙이 변경될 수 있음
   - **대응**: API 버전 관리, 추상화 레이어 도입
   
2. **Rate Limit**: API 호출 제한으로 인한 제약
   - **대응**: 효율적인 호출 스케줄링, 캐싱 전략

3. **시장 변동성**: 급격한 시장 변동 시 과부하
   - **대응**: 큐 시스템 도입, 우선순위 처리

4. **데이터 정합성**: 실시간 데이터의 일관성 문제
   - **대응**: 트랜잭션 관리, 데이터 검증

### 14.2 기술적 제약
- 키움 REST API는 실계좌 전용 (모의투자 미지원)
- WebSocket 실시간 시세는 별도 구현 필요
- HTS에서 조건식을 먼저 등록해야 함

## 15. 참고 자료

### 15.1 공식 문서
- 키움증권 OpenAPI 개발자 센터
- 키움증권 REST API 문서
- Python 공식 문서

### 15.2 관련 기술
- OAuth 2.0 RFC 6749
- REST API 설계 Best Practices
- SQLAlchemy Documentation
- APScheduler Documentation

## 16. 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내역 |
|------|------|--------|-----------|
| 1.0  | 2025-11-08 | - | 초안 작성 |

---

**문서 승인**
- 작성자: 
- 검토자: 
- 승인자: 
- 승인일:
